name: Package NuGet

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-and-package:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'
      
      - name: Restore dependencies
        working-directory: Bank
        run: dotnet restore
      
      - name: Build solution
        working-directory: Bank
        run: dotnet build --configuration Release --no-restore
      
      - name: Run tests
        working-directory: Bank
        run: dotnet test --configuration Release --no-build --collect:"XPlat Code Coverage" --verbosity normal --results-directory ./TestResults
        continue-on-error: true
      
      - name: Generate coverage report
        working-directory: Bank
        run: |
          dotnet tool install -g dotnet-reportgenerator-globaltool || true
          ReportGenerator "-reports:**/coverage.cobertura.xml" "-targetdir:Cobertura" -reporttypes:MarkdownSummaryGithub || true
        continue-on-error: true
      
      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: Bank/Cobertura
        continue-on-error: true
      
      - name: Install SonarScanner
        run: dotnet tool install --global dotnet-sonarscanner || true
      
      - name: SonarCloud Begin
        run: |
          dotnet sonarscanner begin \
            /k:"${{ secrets.SONAR_PROJECT_KEY }}" \
            /d:sonar.login="${{ secrets.SONAR_TOKEN }}" \
            /d:sonar.host.url="https://sonarcloud.io" \
            /d:sonar.cs.opencover.reportsPaths="**/coverage.opencover.xml"
        working-directory: Bank
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true
      
      - name: Build for SonarCloud
        working-directory: Bank
        run: dotnet build --configuration Release
        continue-on-error: true
      
      - name: SonarCloud End
        run: dotnet sonarscanner end /d:sonar.login="${{ secrets.SONAR_TOKEN }}"
        working-directory: Bank
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true
      
      - name: Build Bank.Domain for packing
        working-directory: Bank/Bank.Domain
        run: dotnet build --configuration Release --no-restore
      
      - name: Pack Bank.Domain
        working-directory: Bank/Bank.Domain
        run: dotnet pack --configuration Release --no-build --output ./nupkg
      
      - name: Publish to GitHub Packages
        permissions:
          contents: read
          packages: write
        run: |
          dotnet nuget add source --username ${{ github.actor }} --password ${{ secrets.GITHUB_TOKEN }} --store-password-in-clear-text --name github "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json"
          dotnet nuget push Bank/Bank.Domain/nupkg/*.nupkg --source github
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

